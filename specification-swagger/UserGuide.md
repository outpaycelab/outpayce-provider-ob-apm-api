
# Provider API User Guide 
## **Purpose and Scope**

This user guide describes the payment features and functionalities offered by Outpayce’s Payment Operations swagger, also known as Provider API swagger. The scope of this user guide concerns only Payments done by Credit Card method of payment.

This document includes detailed descriptions of all fields currently supported in Provider API as well as detailed examples and scenarios of the payment operations currently supported. The aim of this document is to enhance and supplement the existing swagger specification.

It is recommended to read the data objects/elements together with the swagger specification to understand which data to provide, how and when to provide it. Tables are used in this specification with rows holding the data objects/elements while the applicability columns indicating whether the data element/object is applicable for specific capability.

Applicability is indicated using the following notions:

•	**“M”** - Mandatory:     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   *Needed in order to process a request or response through Provider API.*

•	**“C”** - Conditional:  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   *May be present depending on the usecase or capability.*
 
• **“O”** - Optional:   &nbsp; &nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   *Not usually needed to perform a payment transaction but will be added if available.* 
 
•	**“N/A”**   &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;    *If a field is marked N/A for a scheme it means that the field is not part of the transaction to that specific scheme.*

## API Basics
Provider API is a RESTful Service and its endpoints will be called using HTTP POST requests formatted as JSON.

## Environment and URLs
Outpayce provides up to three different environments. Two environments for testing and for you to validate your integration, as well as a Production environment. 
From testing phase to Go Live in Production, we will use different urls in test and production that follow a specific format for the 4 main operation types supported by Provider API (Authorization, Reversal, Capture & Refund). <br> The url structure is **_https://{your-host-name}/outpayce/v1/{endpoint-path}_** where: 


 
_**- {your-host-name}**_ is the base URL you will provide alongside the endpoint you are using to host the API on your side.<br>
_**- {endpoint-path}**_ is the operation type specific path described in our specification swagger.
 <br><br>
 
However, for payment operations events, a different URL is used:
 
**_your-organization-name-in-outpayce.payment.feeds.outpayce.com/{attributed-sap}/SPWREQ/v1/payment/3rd-party-gateway/{your-organization-name-in-outpayce}/{operation-collection}/{operation-id}/events_** where:

 
_**- {attributed_sap}**_ is a uniquely created sap attributed to you that will be communicated during the API integration. <br>
_**- {your-organization-name-in-outpayce}**_ is the agreed name attributed by outpayce to you during the onboarding phase. <br>
_**- {payment.feeds.outpayce.com/{attributed-sap}/SPWREQ/v1/payment/3rd-party-gateway}**_ is the Outpayce part of the link that is necessary to target the good component and redirect to the SI<br>
_**- {operation-collection}**_ is the collection of the concerned operation nature. It is therefore either authorizations , captures or refunds.<br>
_**- {operation-id}**_ is the identifier of the operation generated by Outpayce.
 


#### URL Examples
 
Payment Operations full URL in test environment :  
###### https://{your-host-name_in-test}/outpayce/v1/authorizations/{operationId}

Payment Operations full URL in production environment : 
###### https://{your-host-name_in-production}/outpayce/v1/authorizations/{operationId}

 
Payment Operations Events URL in test environment:  
###### {your-organization-name-in-outpayce}.payment.test.feeds.outpayce.com/{attributed-sap}/SPWREQ/v1/payment/3rd-party-gateway/{your-organization-name-in-outpayce}/captures/{operation-id}/events

Payment Operations Events URL in production environment: 
###### {your-organization-name-in-outpayce}.payment.feeds.outpayce.com/{attributed-sap}/SPWREQ/v1/payment/3rd-party-gateway/{your-organization-name-in-outpayce}/captures/{operation-id}/events



## API versioning 

Provider API employs versioning. In any event, Outpayce will notify you of a new release of Provider API. If the newly released version is backwards compatible, you will have to update your version to accomodate for the new changes. If a major release is not backwards compatible, you will have to apply for a new certification process to account for the new major changes. Minor adjustements that are classified as patches, such as text modifications will not prompt a new certification process or API update.

## **Provider API supported capabilities:**

•	Basic **Authorization** -> Minimum required data with no 3DsV2 data. <br> •	**Authorization** single step -> With capture triggered automatically. <br> • **Authorization** 2 Step -> Authorization with dedicated API Capture Request. <br> •	**Authorization** with 3DsV2 Data <br> •	**Authorization** with Functional Travel Segment data <br> •	Full, Partial and Multiple **Reversal** <br> •	Full. Patial and Multiple **Capture** <br> •	Full, Partial and Multiple **Refund** <br> •	**Payment Operations Events** –> Send updates regarding the final status of a capture or refund operation. <br>

## 1 Authorization Operation
### 1.1 Basic Authorization


![](https://github.com/outpaycelab/outpayce-provider-nexi-api/blob/main/assets/user-guide-assets/Authorization.png)


#### 1.1.1 Description
This is a basic authorization scenario where required Credit Card information is provided to perform a successful authorization. This set of data will always be sent as part of an authorization request, regardless of usecase.
#### 1.1.2 Request parameters
| Field | Applicability | Comments | Expected Format | 
|---------------------|---------------|--------------------------------------------------------------------------------|-----------------------------------| 
| id | M | Amadeus operation identifier | string |  
| AuthorizationType | M | Indicates how the settlement is triggered | "AUTHORIZATION_ONLY" or "AUTHOR_AND_CAPTURE" | 
| method | M | Method of Payment requested at authorization time | string Enum: CARD |  
| amount | M | Operation amount | Object | 
| value | M | Value of the amount | string |
| currencyCode | M | Currency of the indicated amount | string, <br> *minLength: 3, maxLength: 3* <br>| 
| card | M | Payment card details | Object |
| vendorCode | M | Payment card scheme | string, <br> *minLength: 3, maxLength: 3* <br>| 
| cardNumber | M | Credit card number | string | 
| cvv | M |  Card verification value, also known as card security code | string; <br> *min Length: 3, max Length: 4* <br> | 
| expiryDate | M | Credit card expiry date | string | 

##### Basic Authorization request example:

```
  PUT https://{your-host-name}/outpayce/v1/authorizations/{authorizationId} HTTP/1.1
  Content-Type: application/vnd.amadeus+json
  ...
{
  "data": {
    "id": "{authorizationId}",
    "amount": {
      "value": "123.45",
      "currencyCode": "EUR"
    },
    "authorizationType": "AUTHORIZATION_ONLY",
    "method": "CARD",
    "card": {
      "vendorCode": "VI",
      "cardNumber": "4000000000000001",
      "cvv": "123",
      "expiryDate": "2024-12"
    }
  }
}
```

#### 1.1.3 Response parameters
   | Object/Field Name   | Applicability   | Comments                                                          | Expected Format   |
   |----------------------|------------------|-------------------------------------------------------------------|--------------------|
   | id                   | M                | Amadeus operation identifier                                     | string             |
   | method               | M                | Method of Payment requested at authorization time              | string Enum: CARD   |
   | timestamp            | M                | Datetime of the operation                                          | String,    Format: <br> *"date-time"* <br> |
   | approvalCode         | M                | Approval code of the processed Authorization request             | string             |
   | card                 | M                | Payment card details                                             | Object             |
   | vendorCode           | M                | Payment card scheme                                               | string, <br> *minLength: 3,  maxLength: 3* <br>|
   | maskedCardNumber     | M                | Credit card number                                              | string             |
   | externalId           | O                | Identifier of the operation generated by the service host      | string             |
   | schemeTransactionId  | O                | Identifier of the payment transaction in the card scheme system   | string             |

The table above contains the minimum amount of data Outpayce expects to receive in the response. Without at least the fields tagged as **Mandatory**, Outpayce will not be able to process the Authorization response. <br>

There are however other optional fields that can be sent in the response such as **_externalId_** and **_schemeTransactionId_**.

##### Basic Authorization response example:

```
HTTP/1.1 201 Created
Location: https://{your-host-name}/outpayce/v1/authorizations/{authorizationId}
Content-Type: application/vnd.amadeus+json

{
  "data": {
    "operationId": "authorizationId",
    "method": "CARD",
    "card": {
      "vendorCode": "VI",
      "maskedCardNumber": "400000------0001"
      },
    "approvalCode": "APPROVAL_CODE",
    "timestamp": "2022-11-28-T13:37:00Z"
  }
}
```

  ### 1.2 Authorization with additional data
   #### 1.2.1 Description
   This is an authorization request that includes Merchant and/or Acquirer details. If these are provided to Outpayce, they will automatically be sent within the Request.
   #### 1.2.2 Request parameters
   The same data in a *basic authorization* request will be provided, alongside the additional data highlighted below:
| Fields | Applicability | Comments | Expected Format | 
|--------------------------|------------------|-------------------------------------|------------------------|
| holderName | O | Card holder full name registered against that payment card | string |
| OperationContext | O |  | Object |
| merchantAccount | O | Merchant details | object |
| merchantAccount.name | O | Name identifying the merchant in the service host system | string |
| merchantAccount.login | O | Login of a user registered in the service host system and belonging to the merchant | string |
| merchantAccount.password.payload | O | User password | string |
| acquirerInformation | O |  | Object |
| acquirerInformation.acquirerBin | O | Acquirer Bank Identifier Number | string | 
| acquirerInformation.acquirerCountry | O | ISO 3166-1 country code of the acquirer | string | 
| pspReconciliationReference | O             | Authorization PSP reference provided for reconciliation purpose (also identified as PRR in other Amadeus payment applications). This reference is generated by the payee to reconcile the payment settlement against the sales. | String                                        |

   #### 1.2.3 Response parameters
   The same response as basic authorization is expected.
  ### 1.3 Authorization with functional flight data
   #### 1.3.1 Description
   This is an authorization request populated with flight and pasenger details.
   #### 1.3.2 Request parameters
 The same data in a basic authorization request will be provided, alongside the additional data highlighted below:
 | Field | Applicability | Comments | Expected Format | 
   |------------------------------|---------|-----------------------------------------------------------------------------------------------------------------|------------------------------------------------| 
   | card | M | Payment card details |string | 
   | vendorCode | M| Payment card scheme |string, <br> *Min Length: 3, Max Length: 3* <br> |
   | cardNumber |M  | Credit card number | string| 
   | cvv | M | Card verification value, also known as card security code |string, <br> *Min Length: 3, Max Length: 4* <br>| 
   | expiryDate | M | Credit card expiry date |string | 
   | purposeOfOperation | M | Purpose of the payment operation |Object |
   | purposeOfOperation.sales[] | M| Payment operation of the type Sales | Array of Objects | 
   | reference |M | Reference identifying the sales |string  | 
   | referenceType |M  | Type of the reference identifying the sales | string| 
   | referenceOwner | M | Owner of reference type |string | 
   | salesItems[] |M | Sales items information | Array of Objects | 
   | category |M  | Category best qualifying the sales item |String; Enum: FLIGHT | 
   | flightSalesDetails |M | Flight detailed item description as a sales summary item |Object  | 
   | flightLegs[] | M | Flight itinerary details associated to a given passenger as sales summary flight details at flight segment level | Array of Objects | 
   | fareBasisCode | M | Airline fare basis code identifying a fare type |String| 
   | departureAirportCode | M | IATA 3-letter code representing the airport of departure of that flight leg | string|
   | departureTime |M | UTC date and time of the scheduled departure, compliant with ISO8601 | string | 
   | arrivalAirportCode |M | IATA 3-letter code representing the airport of arrival of that flight leg |string  | 
   | arrivalTime |M  | UTC date and time of the scheduled arrival, compliant with ISO8601 | string| 
   | carrierCode | M | IATA code of the carrier in charge of that flight segment |string | 
   | couponNumber | M | Flight coupon number |string | 
   | flightNumber |M  | Flight number associated to the carrier in charge of that flight segment |string |
   | serviceClass |M  | Reference identifying the class of travel and included services |string | 
   | travelDate |M  | Day when travel over that segment begins |string | 
   | passenger | M | Passenger of the flight | Object| 
   | passenger.flightPssengerType | M | Specifies flight passenger type | string| 
   | name |M | Description of the name of a physical person |Object  | 
   | firstName | M | Passenger’s first name |string | 
   | lastName |M  | Passenger’s last name |string | 

#### 1.3.3 Response parameters
   The same response as basic authorization use-case is expected.
   ###	1.4 Authorization with 3DsV2 Data
   #### 1.4.1 Description
   This is an authorization request populated with 3DSv2 authentication details.
   #### 1.4.2 Request parameters
 The same data in a basic authorization request will be provided, alongside the additional data highlighted below:
   | Object/Field Name          | Applicability | Comments                                                                                                              | Expected Format        |
|----------------------------|---------------|------------------------------------------------------------------------------------------------------------------------|-------------------------------|
| cvv                        | O             | Card verification value, also known as card security code, displayed on the back of the payment card. Handling of this very sensitive information must comply with PCI-DSS. | String Min <br> *Length: 3, Max Length: 4*  <br>          |
| expiryDate                 | O             | Credit card expiry date.                                                                                              | string           |
| OperationContext           | M             | Object                                                                                                                 |            |
| threeDomainSecure           | M             | Operation 3-Domain Secure information.                                                                               | Object           |
| collectionIndicator        | C             | Name identifying the merchant in the service host system. Used for Mastercard only. Equivalent of the eci for all other card schemes.    | string            |
| aav                        | C             | UCAF Accountholder Authentication Value. Used purely by Mastercard scheme.                                            | string       |
| cavv                       | C             | Base64-encoded Cardholder Authentication Verification Value. Used by all other card schemes that do not include MasterCard and American Express. | String       |
| aevv                       | C             | Base64-encoded American Express Verification Value.                                                                  | string         |
| eci                        | M             | Computed e-commerce indicator.                                                                                        | string          |
| transStatus                | M             | 3-D Secure 2.x (or later) Final Authentication Result.                                                               | string            |
| dsTransactionId            | M             | 3-D Secure 2.x (or later) Directory Server Transaction Identifier.                                                   | string         |
| version                    | M             | 3-D Secure protocol version.                                                                                          | string      |

 ##### This is the	3DSV2 Matrix for the different schemes:
   | Card Type   | Field                               |
   |-------------|-------------------------------------|
   | Amex | aevv |
   | Mastercard  | aav   |
   | Visa and other vendors | cavv |
   |-------------|-----------------------------|
   | Visa, Amex and other vendors  | ECI value |
   | Mastercard  | Collection Indicator |
   
   
   #### 1.4.3 Response parameters
   The same response as basic authorization use-case is expected.
### 1.5 Authorization with Card on File Capabilities
#### 1.5.1 Initial Storing request of CC details
##### 1.5.1.1 Description
This is an authorization scenario where the cardholder initiates the transaction and CC credentials are stored for the first time. On top of setting the field _transactionInitiator_ as **'HOLDER'**, the API consumer also indicates the _instrumentFilingRequest_ of **'STORING'**
##### 1.5.1.2 Request parameters
   The same data in a basic authorization request will be provided, alongside the additional data highlighted below:
| Field | Applicability | Comments | Expected Format | 
|---------------------|---------------|--------------------------------------------------------------------------------|-----------------------------------| 
| OperationContext | M | Object | |
| merchantAccount | M | Merchant details. | object |
| merchantAccount.name | M | Name identifying the merchant in the service host system. | string |
| merchantAccount.login | M | Login of a user registered in the service host system and belonging to the merchant. | string |
| merchantAccount.password.payload | M | User password. | string |
| acquirerInformation | M | Information related to the acquirer of a payment operation. | Object |
| acquirerInformation.acquirerBin | M | Acquirer Bank Identifier Number. | string | 
| acquirerInformation.acquirerCountry | M | ISO 3166-1 country code of the acquirer. | string | 
| transactionInitiator  |   M | Indicate whether the transaction is a MERCHANT initiated transaction (MIT) or a payment instrument HOLDER initiated transaction (aka CIT with C standing for cardholder or consumer). |     string   |
| termsAndConditions  |   M |                   |      Object  |
| credentialsOnFile  |   M |                  |      Object  |
| instrumentFilingRequest  | M | Indicate whether the transaction is the one where the credential are being stored for the first time or it is a subsequent follow up transaction that is performed using stored credentials. |  string |

##### 1.5.1.3 Response parameters
   The same response as basic authorization use-case is expected.
#### 1.5.2 Cardholder Initiated Transaction with Card on File
##### 1.5.2.1 Description
This is an authorization scenario where the cardholder initiates the transaction using stored credentials. On top of setting the _transactionInitiator_ as **'HOLDER'**, the API consumer also indicates the _instrumentFilingRequest_ of **'REUSE'**.
##### 1.5.2.2 Request parameters
   The same data fiels in a basic authorization request will be provided, alongside the additional data fields highlighted below:

| Field | Applicability | Comments | Expected Format | 
|---------------------|---------------|--------------------------------------------------------------------------------|-----------------------------------| 
|transactionIntent|M|           |String|
|interactionCondition|M|                     |String|

##### 1.5.2.3 Response parameters
   The same response as basic authorization use-case is expected.
#### 1.5.3 Merchant Initiated Transaction with Card on File
##### 1.5.3.1 Description
This is an authorization scenario where the merchant initiates the transaction, on behalf of the cardholder. In that case, on top of setting the _transactionInitiator_ as **'MERCHANT'**, this time the API consumer also indicates the _instrumentFilingRequest_ of **'REUSE'**.
##### 1.5.3.2 Request parameters
The same fields than Cardholder Initiated Transaction with Card on File.
##### 1.5.3.3 Response parameters
   The same response as basic authorization use-case is expected.

## 2 Reversal Operation

![](https://github.com/outpaycelab/outpayce-provider-nexi-api/blob/main/assets/user-guide-assets/Reversal.png) 
### 2.1 Basic Reversal 
These are the fields that will always be incorporated in the Payload of the request sent by Outpayce. This refers to the minimum amount of information needed to perform a Reversal request.
#### 2.1.2 Request fields
| Object/field name | Applicability | Comments                                                      | Expected format |
|-------------------|---------------|---------------------------------------------------------------|------------------|
| id                | M             | Amadeus operation identifier.  This identifier is generated by Amadeus Payment Platform and uniquely represents this operation.     | string           |
| parentOperationId | M             | Identifier of a previous Authorization operation belonging to the same      | string           |
| timestamp         | M             | Datetime of the operation.                                      | string           |
| amount            | M             | Operation amount.                                              | Object           |
| value             | M             | Value of the amount.                                           | string           |
| currencyCode      | M             | Currency of the indicated amount.                               | String, <br> *minLength: 3, maxLength: 3* <br> |
| approvalCode      | M           | Approval code of a previously processed Authorization request. | string, <br> *minLength: 3, maxLength: 3* <br>   |
| method            | M            | Method of Payment requested at authorization time.               | String Enum:  Card   |


#### 2.1.3 Response fields
| Object/field name | Applicability | Comments | Expected format |
|---------------------|---------------|---------------------------------------------------------------|------------------| 
| id | M | Amadeus operation identifier. | This identifier is generated by Amadeus Payment Platform and  uniquely represents this operation | String | 
| parentOperationId | M | Identifier of a previous operation belonging to the same payment. | String| 
| method | M | Method of Payment requested at authorization time. | String Enum: CARD | 
| timestamp | M | Datetime of the operation. | string |
| approvalCode | M | Approval code of the processed Authorization request. | string |
| card | M | Payment card details. | Object | 
| vendorCode | M | Payment card scheme. | String, <br> *minLength: 3*, *maxLength: 3* <br>| 
| maskedCardNumber | M | Credit card number. | string |

The table above contains the minimum amount of data Outpayce expects to receive in the response. Without at least the fields tagged as **Mandatory**, Outpayce will not be able to process the Reversal response. <br>

### 2.2 Reversal with optional data
If merchant or acquirer details are needed/provided, these will automatically be added to the request payload.

#### 2.2.1 Request fields
The same data in a basic Reversal request will be provided, alongside the additional data highlighted below if available:

| Object/field name              | Applicability | Comments                                                        | Expected format |
|--------------------------------|---------------|-----------------------------------------------------------------|------------------|
| card                           | O            | Payment card details.                                            | Object           |
| vendorCode                     | O             | Payment card scheme.                                             | String, <br> *minLength: 3, maxLength: 3* <br> |
| cardNumber                     | O          | Credit card number.                                              | string           |
| expiryDate                     | O             | Credit card expiry date.                                         | string           |
| holderName                     | O             | Card holder full name registered against that payment card.     | string           |
| OperationContext               | O             | Object                                                          |                  |
| merchantAccount                | O             | Merchant details.                                               | Object           |
| merchantAccount.name           | O             | Name identifying the merchant in the service host system.       | string           |
| merchantAccount.login          | O             | Login of a user registered in the service host system and belonging to the merchant.       | string           |
| merchantAccount.password.payload| O             | User password.                                                  | string           |
| acquirerInformation            | O             |                                                                 |                  |
| acquirerInformation.acquirerBin                          |    O   | Acquirer Bank Identifier Number.                                 | string           |
| acquirerInformation.acquirerCountry| O     |           ISO 3166-1 country code of the acquirer.       |       String  |  

#### 2.2.2 Response fields
The same response as basic reversal use-case is expected.


## 3 Capture Operation

![](https://github.com/outpaycelab/outpayce-provider-nexi-api/blob/main/assets/user-guide-assets/Capture.PNG) 
## 3.1 Capture simple request
These are the fields that will always be incorporated in the Payload of the request sent by Outpayce. The minimum amount of information needed to perform a Capture request.

### 3.1.1 Request
| Object/Field Name | Applicability | Comments | Expected Format | 
|----------------------|---------------|------------------------------------------------------------------------------|------------------|
| id | M | Amadeus operation identifier. This identifier is generated by Amadeus Payment Platform and uniquely represents this operation. | string | 
| parentOperationId | M | Identifier of a previous Authorization operation belonging to the same payment. | String |
| method | M | Method of Payment requested at authorization time. | String Enum: CARD|
| approvalCode | M | Approval code of a previously processed Authorization request. | string |
| timestamp | M | Datetime of the operation. | string |
| amount | M | Operation amount. | Object |
| value | M | Value of the amount. | string | 
| currencyCode | M | Currency of the indicated amount. | string, <br> *minLength: 3, maxLength: 3* <br> | 
| card | M | Payment card details. | Object |
| vendorCode | M | Payment card scheme. | string, <br> *minLength: 3, maxLength: 3* <br>|
| cardNumber | M | Credit card number. | string |
| expiryDate | M | Credit card expiry date. | string |
| OperationContext | M | | Object | 
| links | M | | object | 
| rel | M | Relation of the link. In addition to IANA standard relations, payment area bears domain specific ones: "webhook" to indicate where the API consumer is expected to update the status of a specific operation. Please refer to the Payment Operation Events API for more details. | string | 
| href | M | Absolute or relative URL. | string |

### 3.1.2 Response

| Object/Field Name   | Applicability | Comments                                                                   | Expected Format |
|----------------------|---------------|------------------------------------------------------------------------------|------------------|
| id                   | M             | Amadeus operation identifier. This identifier is generated by Amadeus Payment Platform and uniquely represents this operation. | string  |
| parentOperationId   | M             | Identifier of a previous operation belonging to the same payment.             | string           |
| method              | M             | Method of Payment requested at authorization time.                            | String Enum: CARD|
| timestamp           | M             | Datetime of the operation.                                                   | string, format: <br> *"date-time"* <br> |
| approvalCode        | M             | Approval code of the processed Authorization request.                        | string           |
| status              | M             | Operation status. For CARD method of payment, this value must be "RECEIVED" and must be present in CAPTURE & REFUND Operation responses. Otherwise, Outpayce System will not be able to process the transaction. | String Expected value: RECEIVED in case of CC method of payment |
| amount              | M             | Operation amount.                                                           | Object           |
| value               | M             | Value of the amount.                                                        | string           |
| currencyCode        | M             | Currency of the indicated amount.                                            | String     | <br> *minLength: 3,  maxLength: 3* <br>   |

The table above contains the minimum amount of data Outpayce expects to receive in the response. Without at least the fields tagged as **Mandatory**, Outpayce will not be able to process the Capture response. <br>

## 3.2 Capture request with optional data
### 3.2.1 Request
The same data in a basic Capture request will be provided, alongside the additional data highlighted below:
 
| Object/Field Name          | Applicability | Comments                                                                   | Expected Format |
|-----------------------------|---------------|------------------------------------------------------------------------------|------------------|
| card                       | M             | Payment card details.                                                       | Object           |
| holderName                 | O             | Card holder full name registered against that payment card.                  | string           |
| OperationContext          | O             |                                                                              | Object           |
| merchantAccount            | O             | Merchant details.                                                           | Object           |
| merchantAccount.name       | O             | Name identifying the merchant in the service host system.                    | string           |
| merchantAccount.login      | O             | Login of a user registered in the service host system and belonging to the merchant. | string           |
| merchantAccount.password.payload | O        | User password.                                                              | string           |
| acquirerInformation        | O             |                                                                              |                  |
| acquirerInformation.acquirerBin | O        | Acquirer Bank Identifier Number.                                            | string           |
| acquirerInformation.acquirerCountry | O   | ISO 3166-1 country code of the acquirer.                                    | string           |
| purposeOfOperation         | O            | Purpose of the payment operation.                                            | Object           |
| purposeOfOperation.sales[]  | O            | Payment operation of the type Sales.                                         | Array Object     |
| salesItems[]               | O            | Sales items information.                                                    | Array Object     |
| flightSalesDetails         | O            | Flight detailed item description as a sales summary item.                   | Object           |
| ticketNumber               | O          | Ticket number of the flight. Not present at Authorization time.             | string           |

### 3.2.2 Response

The same response as basic capture use-case is expected.

## 4 Refund Operation
![](https://github.com/outpaycelab/outpayce-provider-nexi-api/blob/main/assets/user-guide-assets/Refund.png)
## 4.1 Refund simple request
These are the fields that will always be incorporated in the Payload of the request sent by Outpayce. The minimum amount of information needed to perform a Refund request.

### 4.1.1 Request
| Object/Field Name | Applicability | Comments | Expected Format | 
|----------------------|---------------|------------------------------------------------------------------------------|------------------|
| id | M | Amadeus operation identifier. This identifier is generated by Amadeus Payment Platform and uniquely represents this operation. | string | 
| parentOperationId | M | Identifier of a previous Authorization operation belonging to the same payment. If authorization operation is not retrievable, the identifier of the Capture Operation will be used instead. | String |
| method | M | Method of Payment requested at authorization time. | String Enum: CARD|
| approvalCode | M | Approval code of a previously processed Authorization request. | string |
| timestamp | M | Datetime of the operation. | string |
| amount | M | Operation amount. | Object |
| value | M | Value of the amount. | string | 
| currencyCode | M | Currency of the indicated amount. | string,  <br> *minLength: 3, maxLength: 3* <br> | 
| card | M | Payment card details. | Object |
| vendorCode | M | Payment card scheme. | String, <br> *minLength: 3, maxLength: 3* <br> |
| cardNumber | M | Credit card number. | string |
| expiryDate | M | Credit card expiry date. | string |
| OperationContext | M | | Object | 
| links | M | | object | 
| rel | M | Relation of the link. In addition to IANA standard relations, payment area bears domain specific ones: "webhook" to indicate where the API consumer is expected to update the status of a specific operation. Please refer to the Payment Operation Events API for more details. | string | 
| href | M | Absolute or relative URL. | string |

### 4.1.2 Response

| Object/Field Name   | Applicability | Comments                                                                   | Expected Format |
|----------------------|---------------|------------------------------------------------------------------------------|------------------|
| id                   | M             | Amadeus operation identifier. This identifier is generated by Amadeus Payment Platform and uniquely represents this operation. | string  |
| parentOperationId   | M             | Identifier of a previous operation belonging to the same payment.             | string           |
| method              | M             | Method of Payment requested at authorization time.                            | String Enum: CARD|
| timestamp           | M             | Datetime of the operation.                                                   | String, format: <br> *"date-time"* <br>       |
| approvalCode        | M             | Approval code of the processed Authorization request.                        | string           |
| status              | M             | Operation status. For CARD method of payment, this value must be "RECEIVED" and must be present in CAPTURE & REFUND Operation responses. Otherwise, Outpayce System will not be able to process the transaction. | String Expected value: RECEIVED in case of CC method of payment |
| amount              | M             | Operation amount.                                                           | Object           |
| value               | M             | Value of the amount.                                                        | string           |
| currencyCode        | M             | Currency of the indicated amount.                                            | String     | <br> *minLength: 3, maxLength: 3* <br>  |

The table above contains the minimum amount of data Outpayce expects to receive in the response. Without at least the fields tagged as **Mandatory**, Outpayce will not be able to process the Refund response. <br>

## 4.2 Refund request with optional data

### 4.2.1 Request
The same data in a basic Capture request will be provided, alongside the available additional data highlighted below:

| Object/Field Name          | Applicability | Comments                                                                   | Expected Format |
|-----------------------------|---------------|------------------------------------------------------------------------------|------------------|
| holderName                 | O             | Card holder full name registered against that payment card.                  | string           |
| OperationContext          | O             |                                                                              | Object           |
| merchantAccount            | O             | Merchant details.                                                           | Object           |
| merchantAccount.name       | O             | Name identifying the merchant in the service host system.                    | string           |
| merchantAccount.login      | O             | Login of a user registered in the service host system and belonging to the merchant. | string           |
| merchantAccount.password.payload | O        | User password.                                                              | string           |
| acquirerInformation        | O             |                                                                              |                  |
| acquirerInformation.acquirerBin | O        | Acquirer Bank Identifier Number.                                            | string           |
| acquirerInformation.acquirerCountry | O   | ISO 3166-1 country code of the acquirer.                                    | string           |
| purposeOfOperation         | O            | Purpose of the payment operation.                                            | Object           |
| purposeOfOperation.sales[]  | O            | Payment operation of the type Sales.                                         | Array Object     |
| salesItems[]               | O            | Sales items information.                                                    | Array Object     |
| flightSalesDetails         | O            | Flight detailed item description as a sales summary item.                   | Object           |
| ticketNumber               | O          | Ticket number of the flight. Not present at Authorization time.             | string           |

### 4.2.2 Response
The same response as basic refund use-case is expected.

## 5 Payment Operations Events
### 5.1	Pre-requisite - Operation creation

Outpayce sent a payment operation to your system that accepted it. This operation is identified by its nature (i.e. capture or refund) and its id. 

In the payload of the operation request, you received a **_WEBHOOK_URL_** to which you can post Events. This **_WEBHOOK_URL_** respects the following pattern: 

**_https://{your-organization-name-in-outpayce}.payment.feeds.outpayce.com/{unique-SAP}/SPWREQ/v1/payment/3rd-party-gateway/{your-organization-name-in-outpayce}/{operation-collection}/{operation-id}/events_**

In this pattern, _unique-SAP_ is a newly unique created SAP by Outpayce, _your-organization-name-in-Outpayce_ is the agreed name attributed by Outpayce to you during the onboarding phase. *operation-collection* is the collection of the concerned operation nature. It is therefore either *captures* or *refunds*. *operation-id* is the identifier of the operation generated by Outpayce.
For more details about this step, please refer to the Payment Operations swagger

### 5.2 Request parameters

| Field | Applicability | Comments | Expected Format | 
|---------------------|---------------|--------------------------------------------------------------------------------|-----------------------------------| 
| triggerEventName | M | Describes the nature of the event. We expect that this is the final status of the operation.  | string |  
| triggerEventReason | O | Reason why this event has been triggered. Free text. | string | 
| dateTime | O | time of the change (ISO 8601)  | string, Format: <br> *"date-time"* <br> |  
| triggerEventReason | O | To be used by application that has a requirement to send the code and the description of the code | Object | 
| code | O | This will return the code setup by an organization | string | 
| text | O | Free Text | string |

The field *triggerEventReason* field must contain one of the following:

•	**CAPTURE_CLEARED**: both acquirer and issuer agreed on the clearing of the operation.<br>
•	**CAPTURE_FAILURE**: a technical issue prevented the operation to be cleared.<br>
•	**CAPTURE_DENIAL**: the issuer or the acquire denied the clearing request.<br>
•	**REFUND_CLEARED**: both acquirer and issuer agreed on the clearing of the operation.<br>
•	**REFUND_FAILURE**: a technical issue prevented the operation to be cleared.<br>
•	**REFUND_DENIAL**: the issuer or the acquire denied the clearing request.

##### Payment Operations Events request example:

```
  POST your-organization-name-in-outpayce.payment.feeds.outpayce.com/v1/payment/3rd-party-gateway/{your-organization-name-in-outpayce}/{operation-type}/{operation-id}/events
  Content-Type: application/vnd.amadeus+json
  ...
{
    "data": {
        "triggerEventName": "CAPTURE_CLEARED",
        "dateTime": "2033-12-31T04:54:00Z"
    }
}
```

### 5.2 Response parameters
Outpayce parses the event and after processing it, will returns an acknowledgment response.

| Field | Applicability | Comments | Expected Format | 
|---------------------|---------------|--------------------------------------------------------------------------------|-----------------------------------| 
| status | M | Operation status.  | string |  

**NB:** IP whitelisting is used as security on 1A side.

##### Payment Operations Events response example:

```
  HTTP/1.1 200 OK
  Content-Type: application/vnd.amadeus+json
  ...
{
    "data": {
        "status": "ACKNOWLEDGED"
    }
}
```

## 6 Warnings and Error Handling 

Warnings are non-blocking issues encountered during processing. Errors are functionally blocking issues preventing a successful processing. Today Provider API supports only error issues.
In case an error is triggered, Outpayce expects to receive a response following the specific format described in the provided swagger. 

For a full list of existing HTTP Status Codes as well as supported error codes, please refer to the main Provider API Swagger. 
Please remember the code provided must be part of the existing list or Outpayce will not be able to process the response sent.

### 6.1 Error response parameters

| Field | Applicability | Comments | Expected Format | 
|---------------------|---------------|--------------------------------------------------------------------------------|-----------------------------------| 
| status | O | The HTTP status code of this response. This is present only in terminal errors which cause an unsuccessful response. In the case of multiple errors, they must all have the same status.  | integer |  
| code | M | A machine-readable error code from the Amadeus Canned Messages table, that will enable the API Consumers code to handle this type of error. | integer | 
| title | M | An error title from the Canned Messages table with a 1:1 correspondence to the error code. This may be localized.  | string |  
| detail | O | An easy-to-read explanation specific to this occurrence of the problem. It should give the API consumer an idea of what went wrong and how to recover from it. Like the title, this field’s value can be localized. | string | 
| source | O | Parameters and fields indicating details concerning the source of the error. | Object |
| parameter | O | The key of the URI path or query parameter that caused the error. | string |
| pointer | O | A JSON Pointer RFC6901 to the associated entity in the request body that caused this error. | string |
| example | O | A sample input to guide the user when resolving this issue. | string |

Two fields are always expected to be received in case of an Error response, however the response can be enhanced with additional fields to convey more specific information regarding the error use case.

##### Error response example:

```
HTTP/1.1 400 BAD REQUEST
Content-Type: application/vnd.amadeus+json
  ...
{
  "errors": [
      {
          "status": 400, 
          "code": 33660, 
          "title": " MISSING REQUIRED INPUT PARAM(S) - PLEASE ADJUST REQUEST"
      }
  ]
} 
```

